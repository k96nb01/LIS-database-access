---
title: "LIS Database Access"
---

In clinical HLA labs, most of your data in stored in Laboratory Information Systems (LIS). Let's learn how to connect to the LIS databases and get at your data! We'll start by loading the libraries we'll need for this project:

```{r}
library(tidyverse)
library(RSQLite)
```

## Connecting to Databases

The `dbConnect()` function in the DBI package allows you to create a connection object with the details of a specific database connection. Below we are creating a connection object *con* that utilizes the SQLite driver (expressed as the function `RSQLite::SQLite()` - note that :: before the function references the package that the function is part of, in case there is another package with an identically named function) to connect to a database stored in the file "file_name.db".

```{r}
# example code - do not run
con <- dbConnect(drv = RSQLite::SQLite(), # driver - type of SQL connection
                 dbname = "LIS_database.db") # file (for SQLite or other file-based DBs)
```

When the connection is established, the *con* connection object will be visible in your environment.

Connections to SQLite are straightforward because they are contained within a single file and do not require additional credentials or other technical connection details (e.g. a port). Review the DBI package documentation and vignettes to learn how to connect to other types of databases using different drivers.

Once connected you may want to see the tables within the database. You can use the `dbListTables()` function on the connection object to review this.

```{r}
dbListTables(conn = con)
```

It looks like there are six tables in the database. Let's take a closer look at the first one, "Patient". The `tbl` function will allow us to view the database table in R.

```{r}
#Connect to the Patient. The code below creates an R table from the "Patient" table our database and assigns it to an object called "Patient_table". Note that by putting the entire piece of code in parentheses (), R will show us the results without having to use the `print()` function.

(Patient_table <- tbl(con, "Patient")) 
```

Take a look at the Patient table from our LIS database. What kind of data is in each column? How many columns are there? How many rows?

This short line of code is pretty simple, but it's remarkable how much is going on behind the scenes. In order to get data from a database like our LIS database, we need to communicate with it via a computer language called SQL. However, using the `dbplyr` package in R, we don't have to learn another language - we can use the regular R functions we know and they will be silently translated to SQL when R talks to the database. Pretty neat! Let's try a really useful R function called `count`:

```{r}
# Run the code below. Looking at the code, what do you think it's doing?
Patient_table %>% count(categoryCd)
```

The `count` function creates a table that shows how many cases have each value in a certain column. In the code above, we asked the `count` function to take the "Patient" table from the database and show us all of the values in the "categoryCd" column, and how many cases in the database have each value. Looking at the table above, what is the most frequent value for the "categoryCd" column?

OK, we've looked at the first table in our database, but what about the other tables? Let's get a look at all of them with the code below:

```{r}
(Patient_table <- tbl(con, "Patient")) 
(PatientCase_table <- tbl(con, "PatientCase")) 
(RelatedPatient_table <- tbl(con, "RelatedPatient")) 
(Sample_table <- tbl(con, "Sample")) 
(Test_table <- tbl(con, "Test")) 
(TestDetail_table <- tbl(con, "TestDetail")) 
```

Take a minute to look at the types of data in the tables in our database. Have you noticed that some of the columns in different tables have the same names? This is because the data in the different tables are related to each other - this is the whole idea of "relational databases". Let's play around with relating data from two different tables - the Patient and the Sample table. Let's try to determine all the samples we have for a particular patient:

```{r}
# We will start by filtering the Patient table for a particular patient:

(M.Kobayashi <- 
  Patient_table %>% 
    filter(HospitalID == "1247495203")
)
```

Now that we've filtered for a single patient, we will join that data to the "Sample" table, using what's called a `left_join`. The idea is that the "Patient" table will be our reference

